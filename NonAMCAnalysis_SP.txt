USE [ApexDB]
GO
/****** Object:  StoredProcedure [dbo].[Apex_CRM_NONAMC_Customer_Analysis]    Script Date: 5/9/2020 3:22:21 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[Apex_CRM_NONAMC_Customer_Analysis]
(      
@CallerName  Varchar(100),
@FromDate	Varchar(100),
@ToDate		Varchar(100)

)
AS  
BEGIN  
declare @strQry as varchar(Max)
declare @tmptable as varchar(150)

SET @tmptable =	@CallerName + 'NONAMC_Customer_Analysis_Rpt'

set @strQry = 'IF  EXISTS (SELECT 1 FROM  sys.objects WHERE name=' + CHAR(39) +  @tmptable  + CHAR(39) + ' AND Type=''U'' )'                  
set @strQry = @strQry + ' Drop table ' + @tmptable            
exec (@strQry) 

--set @strQry = 'select Cust_ID,Customer_Name,Date,FORMAT(Date ,''MMM'')MonthName,Time,Ticket_No,Query_Person,Query_Description,Query_Type,Query_Sub_Type,Concern_Person,
--				Portal_Ticket_No ,Status,Remark,With_Whome,Handled_By,Department into ' + @tmptable +' from Service_Log_Details
--				Where Date > = '''+@FromDate+''' and Date < ='''+@ToDate+''' '




--set @strQry =   'select a.Cust_ID,Max(c.Ticket_No)Ticket_No,MAx(c.Date)Date,MAx(FORMAT(Date ,''MMM''))MonthName,MAx(c.Time)Time,Max(c.Customer_Name)Customer_Name,
--Max(c.Status)Status,Max(c.Query_Person)Query_Person
--				,Max(c.Query_Type)Query_Type,Max(c.Query_Sub_Type)Query_Sub_Type,
--				Max(c.Query_Description)Query_Description,MAx(c.With_Whome)With_Whome,MAx(c.Concerned_Developer)Concerned_Developer,Max(c.Portal_Ticket_No)Portal_Ticket_No
--				,MAx(c.Remark)Remark,
--				MAx(a.Company_Name)Company_Name,MAx(c.serial_no)serial_no into ' + @tmptable +'   from Customer_Details a left join Revenue_Details b on a.Cust_ID=b.Cust_ID
--				left join Service_Log_Details c on a.Cust_ID=c.Cust_ID 
--			    where a.Cust_ID not in (Select Cust_ID from Sales_Order_Details where not (Order_For is null or Order_For ='''')  group by Cust_ID ) 
--				and not (c.serial_no is null or c.serial_no = '''' ) and Date > = '''+@FromDate+''' and Date < ='''+@ToDate+''' group by a.Cust_ID  '


--set @strQry =   'select a.Cust_ID,c.Ticket_No,c.Date,FORMAT(Date ,''MMM'')MonthName,c.Time,c.Customer_Name,c.Status,c.Query_Person
--				,c.Query_Type,c.Query_Sub_Type,
--				c.Query_Description,c.With_Whome,c.Concerned_Developer,c.Portal_Ticket_No,c.Remark,
--				a.Company_Name,c.serial_no into ' + @tmptable +'   from Customer_Details a left join Revenue_Details b on a.Cust_ID=b.Cust_ID
--				left join Service_Log_Details c on a.Cust_ID=c.Cust_ID 
--			    where a.Cust_ID not in (Select Cust_ID from Sales_Order_Details where not (Order_For is null or Order_For ='''')  group by Cust_ID ) 
--			and not (c.serial_no is null or c.serial_no = '''' ) and Date > = '''+@FromDate+''' and Date < ='''+@ToDate+'''  '

--set @strQry =   'select a.Cust_ID,Max(c.Ticket_No),Max(c.Date),FORMAT(Max(Date) ,''MMM'')MonthName,Max(c.Time),Max(c.Customer_Name),Max(c.Status),Max(c.Query_Person)
--				,Max(c.Query_Type),Max(c.Query_Sub_Type),
--				Max(c.Query_Description),Max(c.With_Whome),Max(c.Concerned_Developer),Max(c.Portal_Ticket_No),Max(c.Remark),
--				Max(a.Company_Name),Max(c.serial_no) into ' + @tmptable +'   from Customer_Details a left join Revenue_Details b on a.Cust_ID=b.Cust_ID
--				left join Service_Log_Details c on a.Cust_ID=c.Cust_ID 
--			    where a.Cust_ID not in (Select Cust_ID from Sales_Order_Details where not (Order_For is null or Order_For ='''')  group by Cust_ID ) 
--				and not (c.serial_no is null or c.serial_no = '''' ) and Date > = '''+@FromDate+''' and Date < ='''+@ToDate+'''  group by a.Cust_ID'
			



--set @strQry =	'select a.Cust_ID,Max(c.Ticket_No),Max(c.Date),Max(FORMAT(Date ,''MMM''))MonthName,Max(c.Time),Max(c.Customer_Name),Max(c.Status),Max(c.Query_Person)
--				,Max(c.Query_Type),Max(c.Query_Sub_Type)
--				,Max(c.Query_Description),Max(c.With_Whome),Max(c.Concerned_Developer),Max(c.Portal_Ticket_No),Max(c.Remark),Max( (a.Cust_ID ))Non_AMC,
--				Max((a.Company_Name)),Max((c.serial_no) ) into ' + @tmptable +'  from Customer_Details a left join Revenue_Details b on a.Cust_ID=b.Cust_ID
--				left join Service_Log_Details c on a.Cust_ID=c.Cust_ID 
--			    where a.Cust_ID not in (Select Cust_ID from Sales_Order_Details where not (Order_For is null or Order_For ='''')  group by Cust_ID ) 
--				and not (c.serial_no is null or c.serial_no = '''' ) and Date > = '''+@FromDate+''' and Date < ='''+@ToDate+''' group by a.Cust_ID '
			


set @strQry =   'select Max(a.Cust_ID)Cust_ID,c.Ticket_No,MAx(c.Date)Date,MAx(FORMAT(Date ,''MMM''))MonthName,MAx(c.Time)Time,Max(c.Customer_Name)Customer_Name,
Max(c.Status)Status,Max(c.Query_Person)Query_Person
				,Max(c.Query_Type)Query_Type,Max(c.Query_Sub_Type)Query_Sub_Type,
				Max(c.Query_Description)Query_Description,MAx(c.With_Whome)With_Whome,MAx(c.Concerned_Developer)Concerned_Developer,Max(c.Portal_Ticket_No)Portal_Ticket_No
				,MAx(c.Remark)Remark,
				MAx(a.Company_Name)Company_Name,MAx(c.serial_no)serial_no,Max(c.Department)Department into ' + @tmptable +'   
				from Customer_Details a left join Revenue_Details b on a.Cust_ID=b.Cust_ID
				left join Service_Log_Details c on a.Cust_ID=c.Cust_ID 
			    where  a.Cust_ID not in (Select Cust_ID from Sales_Order_Details where not (Order_For is null or Order_For ='''')  group by Cust_ID ) and
				not (c.serial_no is null or c.serial_no = '''' )  and  a.Mark_Delete = ''No'' and 
				c.Department not in (''Bajaj'',''Ultratech'',''Panasonic'',''Birlawhite'')
				and Date > = '''+@FromDate+''' and Date < ='''+@ToDate+''' group by c.Ticket_No'--,a.Cust_ID  '

print(@strQry )
exec (@strQry) 


set @strQry = 'Alter Table ' + @tmptable +' 
				Add Station Varchar(500),State Varchar(500),Zone Varchar(500),TeamTag Varchar(500),City Varchar(500),
				Mumbai int,hub Varchar(500),TotalCalls int,
				Pune int, Rest_OF_Mah int, Rest_Of_India int,
				March int, February int, January int, December int,November int, October int,
				September int, August int, July int, June int, May int,	April int'
print(@strQry )
exec (@strQry) 


set @strQry ='update a set Station=b.Station from  ' + @tmptable +' a 
				join Customer_Details b on a.Cust_ID=b.Cust_ID'
print(@strQry )
exec (@strQry) 


set @strQry ='update a set Hub=b.Hub_Name, Zone=b.Zone from  ' + @tmptable +' a 
				join Hub_Details b on a.Station=b.Station_Name'
print(@strQry )
exec (@strQry) 

set @strQry ='update a set City=b.City from  ' + @tmptable +' a 
				join Hub_Details b on a.Station=b.Station_Name'
print(@strQry )
exec (@strQry) 


set @strQry ='update a set State=b.State from  ' + @tmptable +' a 
				join contact_details b on a.Cust_ID=b.Cust_ID'
print(@strQry )
exec (@strQry) 



set @strQry = 'update a set a.TeamTag=''Mumbai'' from ' + @tmptable +' a where City= ''Mumbai'''
print(@strQry)
exec (@strQry)


set @strQry = 'update a set a.TeamTag=''Pune'' from ' + @tmptable +' a where City= ''Pune'''
print(@strQry)
exec (@strQry)



set @strQry = 'update a set a.TeamTag=''Rest Of Maharashtra'' from ' + @tmptable +' a where 
station not in (Select station_name from hub_details) and State = ''Maharashtra'''
print(@strQry)
exec (@strQry)


set @strQry = 'update a set a.TeamTag=''Rest Of India'' from ' + @tmptable +' a where State <> ''Maharashtra'''
print(@strQry)
exec (@strQry)

set @strQry = 'update a set a.TotalCalls=''1'' from ' + @tmptable +' a join
(Select Cust_Id,Count(Distinct(Ticket_No))TotalCalls from ' + @tmptable +' group by Cust_Id )b on a.Cust_Id=b.Cust_Id'
--on a.Cust_Id=b.Cust_Id'
print(@strQry)
exec (@strQry)


--set @strQry = ' Update a set a.Total_Calls = ''1''  from '+@tmptable+' a  join
--(select Handled_By,count(Status)totalCalls  from '+@tmptable+' where  Status <> ''Closed''  group by Handled_by) b
--on a.Handled_By = b.Handled_By '
--exec(@strQry)




set @strQry = 'update a set a.Mumbai=''1'' from ' + @tmptable +' a where TeamTag=''Mumbai'''
print(@strQry)
exec (@strQry)



set @strQry = 'update a set a.Pune=''1'' from ' + @tmptable +' a where TeamTag=''Pune'''
print(@strQry)
exec (@strQry)


set @strQry = 'update a set a.Rest_Of_Mah=''1'' from ' + @tmptable +' a where TeamTag=''Rest Of Maharashtra'''
print(@strQry)
exec (@strQry)


set @strQry = 'update a set a.Rest_Of_India=''1'' from ' + @tmptable +' a where TeamTag=''Rest Of India'''
print(@strQry)
exec (@strQry)



set @strQry = 'update a set March=''1''  from ' + @tmptable +' a
				where MonthName=''Mar'' '
print(@strQry)
exec (@strQry) 


set @strQry = 'update a set February=''1''  from ' + @tmptable +' a
				where MonthName=''Feb'' '
print(@strQry)
exec (@strQry) 



set @strQry = 'update a set January=''1''  from ' + @tmptable +' a
				where MonthName=''Jan'' '
print(@strQry)
exec (@strQry) 



set @strQry = 'update a set December=''1''  from ' + @tmptable +' a
				where MonthName=''Dec'' '
print(@strQry)
exec (@strQry) 




set @strQry = 'update a set November=''1''  from ' + @tmptable +' a
				where MonthName=''Nov'' '
print(@strQry)
exec (@strQry) 



set @strQry = 'update a set October=''1''  from ' + @tmptable +' a
				where MonthName=''Oct'' '
print(@strQry)
exec (@strQry) 



set @strQry = 'update a set September=''1''  from ' + @tmptable +' a
				where MonthName=''Sep'' '
print(@strQry)
exec (@strQry) 



set @strQry = 'update a set August=''1''  from ' + @tmptable +' a
				where MonthName=''Aug'' '
print(@strQry)
exec (@strQry) 



set @strQry = 'update a set July=''1''  from ' + @tmptable +' a
				where MonthName=''Jul'' '
print(@strQry)
exec (@strQry) 



set @strQry = 'update a set June=''1''  from ' + @tmptable +' a
				where MonthName=''Jun'' '
print(@strQry)
exec (@strQry) 



set @strQry = 'update a set May=''1''  from ' + @tmptable +' a
				where MonthName=''May'' '
print(@strQry)
exec (@strQry) 



set @strQry = 'update a set April=''1''  from ' + @tmptable +' a
				where MonthName=''Apr'' '
print(@strQry)
exec (@strQry) 


end

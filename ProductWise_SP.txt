USE [ApexDB]
GO
/****** Object:  StoredProcedure [dbo].[Apex_CRM_Revenue_Yearly_SP]    Script Date: 6/6/2020 2:35:50 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[Apex_CRM_ProductWise_Monthly_Sales_SP]
(      
@CallerName  Varchar(100)
--@FromDate	Varchar(100),
--@ToDate		Varchar(100)

)
AS  
BEGIN  
declare @strQry as varchar(Max)
declare @tmptable as varchar(150)

SET @tmptable =	@CallerName + 'Apex_CRM_ProductWise_Monthly_Sales_Table'


set @strQry = 'IF  EXISTS (SELECT 1 FROM  sys.objects WHERE name=' + CHAR(39) +  @tmptable  + CHAR(39) + ' AND Type=''U'' )'                  
set @strQry = @strQry + ' Drop table ' + @tmptable            
exec (@strQry) 



set @strQry ='Select  Cust_ID,Billing_Name,Date,FORMAT(Date ,''MMM'')MonthName,Order_For,Order_Sub_Type,User_Name,
Sales_Owner,Discount_Per,Margin_Amt,Discount_Amt,stage into ' + @tmptable +'  from Sales_Order_Details'
print(@strQry )
exec (@strQry) 

set @strQry = 'Alter Table ' + @tmptable +' 
				Add UserName Varchar(500),TeamName Varchar(500),Jan_Count int ,Feb_Count int,Mar_Count int,Apr_Count int,
				May_Count int,Jun_Count int,Jul_Count int,Aug_Count int,Sep_Count int,Oct_Count int,Nov_Count int,Dec_Count int,
				Jan_Amt int,Feb_Amt int,Mar_Amt int,Apr_Amt int,May_Amt int,Jun_Amt int,Jul_Amt int,Aug_Amt int,Sep_Amt int,
				Oct_Amt int,Nov_Amt int,Dec_Amt int'
print(@strQry )
exec (@strQry) 


set @strQry = 'update a set a.UserName=b.User_Name2 from ' + @tmptable +' a 
				join Login_Details b on a.Sales_Owner=b.Login_Nm'
print(@strQry)
exec (@strQry) 


set @strQry = 'update a set a.TeamName=b.Team from ' + @tmptable +' a join Login_Details b on a.Sales_Owner=b.Login_Nm'
print(@strQry)
exec (@strQry) 


set @strQry = 'update a set Jan_Count=''1''  from ' + @tmptable +' a
				where MonthName=''Jan'' '
print(@strQry)
exec (@strQry) 


set @strQry = 'update a set Feb_Count=''1''  from ' + @tmptable +' a
				where MonthName=''Feb'' '
print(@strQry)
exec (@strQry) 


set @strQry = 'update a set Mar_Count=''1''  from ' + @tmptable +' a
				where MonthName=''Mar'' '
print(@strQry)
exec (@strQry) 


set @strQry = 'update a set Apr_Count=''1''  from ' + @tmptable +' a
				where MonthName=''Apr'' '
print(@strQry)
exec (@strQry) 


set @strQry = 'update a set May_Count=''1''  from ' + @tmptable +' a
				where MonthName=''May'' '
print(@strQry)
exec (@strQry) 

set @strQry = 'update a set Jun_Count=''1''  from ' + @tmptable +' a
				where MonthName=''Jun'' '
print(@strQry)
exec (@strQry) 


set @strQry = 'update a set Jul_Count=''1''  from ' + @tmptable +' a
				where MonthName=''Jul'' '
print(@strQry)
exec (@strQry) 



set @strQry = 'update a set Aug_Count=''1''  from ' + @tmptable +' a
				where MonthName=''Aug'' '
print(@strQry)
exec (@strQry) 

set @strQry = 'update a set Sep_Count=''1''  from ' + @tmptable +' a
				where MonthName=''Sep'' '
print(@strQry)
exec (@strQry) 

set @strQry = 'update a set Oct_Count=''1''  from ' + @tmptable +' a
				where MonthName=''Oct'' '
print(@strQry)
exec (@strQry) 

set @strQry = 'update a set Nov_Count=''1''  from ' + @tmptable +' a
				where MonthName=''Nov'' '
print(@strQry)
exec (@strQry) 

set @strQry = 'update a set Dec_Count=''1''  from ' + @tmptable +' a
				where MonthName=''Dec'' '
print(@strQry)
exec (@strQry) 



--set @strQry = ' update a set a.Jan_Amt = b.Apex_Revenue from '+@tmptable+' a join
--(select MonthName,Cust_ID,(Discount_Per )Apex_Revenue from '+@tmptable+' 
--where  MonthName = ''Jan''  ) b
--on a.MonthName=b.MonthName and a.Cust_ID=b.Cust_ID' 
--print(@strQry)
--exec(@strQry)


set @strQry = ' update a set a.Jan_Amt = b.Apex_Revenue from '+@tmptable+' a join
(select (MonthName)MonthName,(Cust_ID)Cust_ID,(Discount_Per-(Margin_Amt+Discount_Amt))Apex_Revenue from '+@tmptable+' 
where  MonthName = ''Jan''  ) b
on a.MonthName=b.MonthName and a.Cust_ID=b.Cust_ID' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Feb_Amt = b.Apex_Revenue from '+@tmptable+' a join
(select (MonthName)MonthName,(Cust_ID)Cust_ID,(Discount_Per-(Margin_Amt+Discount_Amt))Apex_Revenue from '+@tmptable+' 
where  MonthName = ''Feb''  ) b
on a.MonthName=b.MonthName and a.Cust_ID=b.Cust_ID' 
print(@strQry)
exec(@strQry)


set @strQry = ' update a set a.Mar_Amt = b.Apex_Revenue from '+@tmptable+' a join
(select (MonthName)MonthName,(Cust_ID)Cust_ID,(Discount_Per-(Margin_Amt+Discount_Amt))Apex_Revenue from '+@tmptable+' 
where  MonthName = ''Mar''  ) b
on a.MonthName=b.MonthName and a.Cust_ID=b.Cust_ID' 
print(@strQry)
exec(@strQry)


set @strQry = ' update a set a.Apr_Amt = b.Apex_Revenue from '+@tmptable+' a join
(select (MonthName)MonthName,(Cust_ID)Cust_ID,(Discount_Per-(Margin_Amt+Discount_Amt))Apex_Revenue from '+@tmptable+' 
where  MonthName = ''Apr''  ) b
on a.MonthName=b.MonthName and a.Cust_ID=b.Cust_ID' 
print(@strQry)
exec(@strQry)


set @strQry = ' update a set a.May_Amt = b.Apex_Revenue from '+@tmptable+' a join
(select (MonthName)MonthName,(Cust_ID)Cust_ID,(Discount_Per-(Margin_Amt+Discount_Amt))Apex_Revenue from '+@tmptable+' 
where  MonthName = ''May''  ) b
on a.MonthName=b.MonthName and a.Cust_ID=b.Cust_ID' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Jun_Amt = b.Apex_Revenue from '+@tmptable+' a join
(select (MonthName)MonthName,(Cust_ID)Cust_ID,(Discount_Per-(Margin_Amt+Discount_Amt))Apex_Revenue from '+@tmptable+' 
where  MonthName = ''Jun''  ) b
on a.MonthName=b.MonthName and a.Cust_ID=b.Cust_ID' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Jul_Amt = b.Apex_Revenue from '+@tmptable+' a join
(select (MonthName)MonthName,(Cust_ID)Cust_ID,(Discount_Per-(Margin_Amt+Discount_Amt))Apex_Revenue from '+@tmptable+' 
where  MonthName = ''Jul''  ) b
on a.MonthName=b.MonthName and a.Cust_ID=b.Cust_ID' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Aug_Amt = b.Apex_Revenue from '+@tmptable+' a join
(select (MonthName)MonthName,(Cust_ID)Cust_ID,(Discount_Per-(Margin_Amt+Discount_Amt))Apex_Revenue from '+@tmptable+' 
where  MonthName = ''Aug''  ) b
on a.MonthName=b.MonthName and a.Cust_ID=b.Cust_ID' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Sep_Amt = b.Apex_Revenue from '+@tmptable+' a join
(select (MonthName)MonthName,(Cust_ID)Cust_ID,(Discount_Per-(Margin_Amt+Discount_Amt))Apex_Revenue from '+@tmptable+' 
where  MonthName = ''Sep''  ) b
on a.MonthName=b.MonthName and a.Cust_ID=b.Cust_ID' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Oct_Amt = b.Apex_Revenue from '+@tmptable+' a join
(select (MonthName)MonthName,(Cust_ID)Cust_ID,(Discount_Per-(Margin_Amt+Discount_Amt))Apex_Revenue from '+@tmptable+' 
where  MonthName = ''Oct''  ) b
on a.MonthName=b.MonthName and a.Cust_ID=b.Cust_ID' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Nov_Amt = b.Apex_Revenue from '+@tmptable+' a join
(select (MonthName)MonthName,(Cust_ID)Cust_ID,(Discount_Per-(Margin_Amt+Discount_Amt))Apex_Revenue from '+@tmptable+' 
where  MonthName = ''Nov''  ) b
on a.MonthName=b.MonthName and a.Cust_ID=b.Cust_ID' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Dec_Amt = b.Apex_Revenue from '+@tmptable+' a join
(select (MonthName)MonthName,(Cust_ID)Cust_ID,(Discount_Per-(Margin_Amt+Discount_Amt))Apex_Revenue from '+@tmptable+' 
where  MonthName = ''Dec''  ) b
on a.MonthName=b.MonthName and a.Cust_ID=b.Cust_ID' 
print(@strQry)
exec(@strQry)

--set @strQry = ' update a set a.Jan_Amt = b.Apex_Revenue from '+@tmptable+' a join
--(select Max(Cust_ID)Cust_ID,Sum(Discount_Per-(Margin_Amt+Discount_Amt))Apex_Revenue from '+@tmptable+' 
--where  MonthName = ''Jan''  ) b
--on a.Cust_ID=b.Cust_ID' 
--print(@strQry)
--exec(@strQry)

--set @strQry = ' update a set a.Jan_Amt = b.Apex_Revenue from '+@tmptable+' a join
--(select Max(MonthName)MonthName,Max(Order_Sub_Type)Order_Sub_Type, Sum(Discount_Per-(Margin_Amt+Discount_Amt))Apex_Revenue from '+@tmptable+' 
--where  MonthName = ''Jan'' ) b
--on a.Order_Sub_Type=b.Order_Sub_Type' 
--print(@strQry)
--exec(@strQry)


End
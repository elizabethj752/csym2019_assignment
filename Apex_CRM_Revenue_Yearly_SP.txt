USE [ApexDB]
GO
/****** Object:  StoredProcedure [dbo].[Apex_CRM_Revenue_Yearly_SP]    Script Date: 6/6/2020 2:35:50 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[Apex_CRM_Revenue_Yearly_SP]
(      
@CallerName  Varchar(100),
@FromDate	Varchar(100),
@ToDate		Varchar(100)

)
AS  
BEGIN  
declare @strQry as varchar(Max)
declare @tmptable1 as varchar(150)
declare @tmptable as varchar(150)
declare @tmptableYear as varchar(150)
declare @tmptableExec as varchar(150)

SET @tmptable1 =	@CallerName + 'Apex_CRM_Revenue_Yearlybase_Table'
SET @tmptable =	@CallerName + 'Apex_CRM_Revenue_Yearly_Table'
SET @tmptableYear =	@CallerName + 'Apex_CRM_Revenue_YearWise_Table'
SET @tmptableExec =	@CallerName + 'Apex_CRM_Revenue_ExecWise_Table'

set @strQry = 'IF  EXISTS (SELECT 1 FROM  sys.objects WHERE name=' + CHAR(39) +  @tmptable1  + CHAR(39) + ' AND Type=''U'' )'                  
set @strQry = @strQry + ' Drop table ' + @tmptable1           
exec (@strQry) 

set @strQry = 'IF  EXISTS (SELECT 1 FROM  sys.objects WHERE name=' + CHAR(39) +  @tmptable  + CHAR(39) + ' AND Type=''U'' )'                  
set @strQry = @strQry + ' Drop table ' + @tmptable            
exec (@strQry) 

set @strQry = 'IF  EXISTS (SELECT 1 FROM  sys.objects WHERE name=' + CHAR(39) +  @tmptableYear  + CHAR(39) + ' AND Type=''U'' )'                  
set @strQry = @strQry + ' Drop table ' + @tmptableYear            
exec (@strQry) 

set @strQry = 'IF  EXISTS (SELECT 1 FROM  sys.objects WHERE name=' + CHAR(39) +  @tmptableExec  + CHAR(39) + ' AND Type=''U'' )'                  
set @strQry = @strQry + ' Drop table ' + @tmptableExec            
exec (@strQry) 


Set @strQry =	'Create table '+@tmptable1+' (Cust_id int, Ticket_No varchar(500), User_Name varchar(500), Amount int, 
				Ref_By varchar(500), Ref_Amount int, Billing_Name varchar(500), Order_For varchar(100), Order_Sub_Type varchar(100),
				Status varchar(100), Stage varchar(100), Date Date, Sales_Owner varchar(500), Firm_Name Varchar(500), 
				Sales_Owner_Revised Varchar(500), Sales_Owner_Revised_MainNM Varchar(500), Entered_By_Revised Varchar(500), 
				Entered_By_Revised_MainNM Varchar(500), Reffered_By_Revised Varchar(500), Reffered_by_User Varchar(500), Reffered_by_Team varchar(500),
				Revenue_Points Money, Discount_Amt int, Margin_Comm int, Gross_Revenue int, Invoice_Value Varchar(500), Payment_Status varchar(500),
				Tally_Portal_Lead_ID varchar(500) )'
exec (@strQry)

Set @strQry =	'Insert into '+@tmptable1+' (Cust_id, Ticket_No, User_Name, Amount, Ref_Amount, Billing_Name, Order_For, Order_Sub_Type,
				Status, Stage, Date, Sales_Owner, Sales_Owner_Revised, Entered_By_Revised, Discount_Amt, Margin_Comm, 
				Gross_Revenue, Invoice_Value, Payment_Status, Tally_Portal_Lead_ID )  
				Select Cust_id, Ticket_No, Lower(Sales_Owner)Sales_Owner, Net_Business, ''0'' ,Billing_Name, Order_For, Order_Sub_Type,
				Status, Stage, Date, Sales_Owner, Sales_Owner, USER_NAME, Discount_Amt, Margin_Amt, 
				Discount_Per, Innvoice_Value, Payment_Status, Tally_Portal_Lead_ID
				from Sales_Order_Details where  stage in (''Revenue'',''Revenue Cancel'')'
exec (@strQry)

Set @strQry =	'Insert into '+@tmptable1+' (Cust_id, Ticket_No, User_Name, Amount, Ref_Amount, Ref_By, Billing_Name, Order_For, Order_Sub_Type,
				Status, Stage, Date, Sales_Owner, Firm_Name, Sales_Owner_Revised, Entered_By_Revised, Payment_Status, Tally_Portal_Lead_ID ) 
				Select Cust_id, Ticket_No, Lower(Reffered_by)Reffered_by,  ''0'' ,Reffered_Amt, Lower(Sales_Owner)Sales_Owner, Billing_Name, Order_For, Order_Sub_Type, 
				Status, Stage, Date, Sales_Owner, Firm_Name, Sales_Owner, USER_NAME, Payment_Status, Tally_Portal_Lead_ID
				from Sales_Order_Details where  stage in (''Revenue'',''Revenue Cancel'')'
exec (@strQry)
--print(@strQry)

set @strQry = ' update a set Reffered_by_Team = b.Team_Nm, Reffered_by_User = b.User_Name2
				from '+@tmptable1+' a join Login_Details b on a.Ref_By=b.Login_Nm   '

print(@strQry)
exec(@strQry)


--	Detailed table
set @strQry =	'select *,FORMAT(Date ,''MMM'')MonthName into '+@tmptable+' from '+@tmptable1+' 
				where Date > = '''+@FromDate+''' and Date < ='''+@ToDate+''' '

print(@strQry)
exec(@strQry)

set @strQry =' Alter Table '+@tmptable+'
				Add UserName Varchar(500), Team Varchar(500),Department Varchar(500), Team_Cost int , 
				TeamCount int, TeamTag Varchar(500), ACC_Team  Varchar(500), TL_Name  Varchar(500), NewTeam_Name  Varchar(500)'
print(@strQry)
exec(@strQry)

set @strQry = ' update a set UserName=b.User_Name2 , Team=b.Team_Nm  ,Department=b.Department, TL_Name = b.Team, NewTeam_Name=b.Team_Nm
				from '+@tmptable+' a join Login_Details b on a.User_Name=b.Login_Nm   '

print(@strQry)
exec(@strQry)


set @strQry = ' update a set NewTeam_Name = ''MFG  - Solutions''
				from '+@tmptable+' a
				where a.Team = ''Manufacturing'' '
print(@strQry)
exec(@strQry)

set @strQry = ' update a set NewTeam_Name = ''SSV - BW''
				from '+@tmptable+' a
				where a.Team = ''Birlawhite'' '
exec(@strQry)

set @strQry = ' update a set NewTeam_Name = ''SSV - Panasonic''
				from '+@tmptable+' a
				where a.Team = ''Panasonic'' '
exec(@strQry)


set @strQry = ' update a set ACC_Team = b.Employee_Name, TeamCount= b.Count_of_Emp, Team_Cost = b.CTC
				from '+@tmptable+' a join Employee_CTC_Details b on a.NewTeam_Name = b.Team  
				where b.Employee_Name like ''%-Common'' '
exec(@strQry)

set @strQry = ' update a set TeamTag=''Team_A'' from '+@tmptable+' a  '
exec(@strQry)
 
set @strQry = ' update a set TeamTag=''Team_D'' from '+@tmptable+' a where Team in (''Vanilla'',''CASD'') '
exec(@strQry)

set @strQry = ' update a set TeamTag=''Team_C'' from '+@tmptable+' a where Team in (''Bajaj'',''Ultratech'',''Birlawhite'',''Panasonic'',''SSV'') '
exec(@strQry)

set @strQry = ' update a set TeamTag=''Team_B'' from '+@tmptable+' a 
				where Team in (''Gem9'',''Aspire'',''Manufacturing'') '
exec(@strQry)

--	Executive wise table

set @strQry =	'select max(Team)Team, max(UserName)UserName, max(TeamTag)TeamTag into '+@tmptableExec+' from '+@tmptable+' group by Team, UserName'
exec(@strQry)

set @strQry = 'Alter Table ' + @tmptableExec +' 
				Add Jan int, Feb int, Mar int, Apr int, May int, Jun int, Jul int, Aug int, Sep int, Oct int, Nov int,	Dec int '
exec (@strQry) 
 
set @strQry = ' update a set a.Jan = b.Apex_Revenue from '+@tmptableExec+' a join
(select MonthName, max(Team)Team, max(UserName)UserName, Sum(Amount + Ref_Amount)Apex_Revenue from '+@tmptable+' 
where  MonthName = ''Jan'' group by MonthName,Team, UserName) b
on a.UserName = b.UserName and a.Team = b.Team' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Feb = b.Apex_Revenue from '+@tmptableExec+' a join
(select MonthName, max(Team)Team, max(UserName)UserName, Sum(Amount + Ref_Amount)Apex_Revenue from '+@tmptable+' 
where  MonthName = ''Feb'' group by MonthName,Team, UserName) b
on a.UserName = b.UserName and a.Team = b.Team' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Mar = b.Apex_Revenue from '+@tmptableExec+' a join
(select MonthName, max(Team)Team, max(UserName)UserName, Sum(Amount + Ref_Amount)Apex_Revenue from '+@tmptable+' 
where  MonthName = ''Mar'' group by MonthName,Team, UserName) b
on a.UserName = b.UserName and a.Team = b.Team' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Apr = b.Apex_Revenue from '+@tmptableExec+' a join
(select MonthName, max(Team)Team, max(UserName)UserName, Sum(Amount + Ref_Amount)Apex_Revenue from '+@tmptable+' 
where  MonthName = ''Apr'' group by MonthName,Team, UserName) b
on a.UserName = b.UserName and a.Team = b.Team' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.May = b.Apex_Revenue from '+@tmptableExec+' a join
(select MonthName, max(Team)Team, max(UserName)UserName, Sum(Amount + Ref_Amount)Apex_Revenue from '+@tmptable+' 
where  MonthName = ''May'' group by MonthName,Team, UserName) b
on a.UserName = b.UserName and a.Team = b.Team' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Jun = b.Apex_Revenue from '+@tmptableExec+' a join
(select MonthName, max(Team)Team, max(UserName)UserName, Sum(Amount + Ref_Amount)Apex_Revenue from '+@tmptable+' 
where  MonthName = ''Jun'' group by MonthName, Team, UserName) b
on a.UserName = b.UserName and a.Team = b.Team' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Jul = b.Apex_Revenue from '+@tmptableExec+' a join
(select MonthName, max(Team)Team, max(UserName)UserName, Sum(Amount + Ref_Amount)Apex_Revenue from '+@tmptable+' 
where  MonthName = ''Jul'' group by MonthName,Team, UserName) b
on a.UserName = b.UserName and a.Team = b.Team' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Aug = b.Apex_Revenue from '+@tmptableExec+' a join
(select MonthName, max(Team)Team, max(UserName)UserName, Sum(Amount + Ref_Amount)Apex_Revenue from '+@tmptable+' 
where  MonthName = ''Aug'' group by MonthName,Team, UserName) b
on a.UserName = b.UserName and a.Team = b.Team' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Sep = b.Apex_Revenue from '+@tmptableExec+' a join
(select MonthName, max(Team)Team, max(UserName)UserName, Sum(Amount + Ref_Amount)Apex_Revenue from '+@tmptable+' 
where  MonthName = ''Sep'' group by MonthName, Team, UserName) b
on a.UserName = b.UserName and a.Team = b.Team' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Oct = b.Apex_Revenue from '+@tmptableExec+' a join
(select MonthName, max(Team)Team, max(UserName)UserName, Sum(Amount + Ref_Amount)Apex_Revenue from '+@tmptable+' 
where  MonthName = ''Oct'' group by MonthName, Team, UserName) b
on a.UserName = b.UserName and a.Team = b.Team' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Nov = b.Apex_Revenue from '+@tmptableExec+' a join
(select MonthName, max(Team)Team, max(UserName)UserName, Sum(Amount + Ref_Amount)Apex_Revenue from '+@tmptable+' 
where  MonthName = ''Nov'' group by MonthName, Team, UserName) b
on a.UserName = b.UserName and a.Team = b.Team' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Dec = b.Apex_Revenue from '+@tmptableExec+' a join
(select MonthName, max(Team)Team, max(UserName)UserName, Sum(Amount + Ref_Amount)Apex_Revenue from '+@tmptable+' 
where  MonthName = ''Dec'' group by MonthName, Team, UserName) b
on a.UserName = b.UserName and a.Team = b.Team' 
print(@strQry)
exec(@strQry)


--	Year wise table

set @strQry =	'select max(Team)Team, max(TeamTag)TeamTag into '+@tmptableYear+' from '+@tmptable+' group by Team'
exec(@strQry)

set @strQry = 'Alter Table ' + @tmptableYear +' 
				Add Jan int, Feb int, Mar int, Apr int, May int, Jun int, Jul int, Aug int, Sep int, Oct int, Nov int,	Dec int '
exec (@strQry) 

set @strQry = ' update a set a.Jan = b.Apex_Revenue from '+@tmptableYear+' a join
(select MonthName, max(Team)Team, Sum(Amount + Ref_Amount)Apex_Revenue 
from '+@tmptable+' where  MonthName = ''Jan'' group by MonthName, Team) b
on a.Team = b.Team' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Feb = b.Apex_Revenue from '+@tmptableYear+' a join
(select MonthName, max(Team)Team, Sum(Amount + Ref_Amount)Apex_Revenue 
from '+@tmptable+' where  MonthName = ''Feb'' group by MonthName, Team) b
on a.Team = b.Team' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Mar = b.Apex_Revenue from '+@tmptableYear+' a join
(select MonthName, max(Team)Team, Sum(Amount + Ref_Amount)Apex_Revenue 
from '+@tmptable+' where  MonthName = ''Mar'' group by MonthName, Team) b
on a.Team = b.Team' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Apr = b.Apex_Revenue from '+@tmptableYear+' a join
(select MonthName, max(Team)Team, Sum(Amount + Ref_Amount)Apex_Revenue 
from '+@tmptable+' where  MonthName = ''Apr'' group by MonthName, Team) b
on a.Team = b.Team' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.May = b.Apex_Revenue from '+@tmptableYear+' a join
(select MonthName, max(Team)Team, Sum(Amount + Ref_Amount)Apex_Revenue 
from '+@tmptable+' where  MonthName = ''May'' group by MonthName, Team) b
on a.Team = b.Team' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Jun = b.Apex_Revenue from '+@tmptableYear+' a join
(select MonthName, max(Team)Team, Sum(Amount + Ref_Amount)Apex_Revenue 
from '+@tmptable+' where  MonthName = ''Jun'' group by MonthName, Team) b
on a.Team = b.Team' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Jul = b.Apex_Revenue from '+@tmptableYear+' a join
(select MonthName, max(Team)Team, Sum(Amount + Ref_Amount)Apex_Revenue 
from '+@tmptable+' where  MonthName = ''Jul'' group by MonthName, Team) b
on a.Team = b.Team' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Aug = b.Apex_Revenue from '+@tmptableYear+' a join
(select MonthName, max(Team)Team, Sum(Amount + Ref_Amount)Apex_Revenue 
from '+@tmptable+' where  MonthName = ''Aug'' group by MonthName, Team) b
on a.Team = b.Team' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Sep = b.Apex_Revenue from '+@tmptableYear+' a join
(select MonthName, max(Team)Team, Sum(Amount + Ref_Amount)Apex_Revenue 
from '+@tmptable+' where  MonthName = ''Sep'' group by MonthName, Team) b
on a.Team = b.Team' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Oct = b.Apex_Revenue from '+@tmptableYear+' a join
(select MonthName, max(Team)Team, Sum(Amount + Ref_Amount)Apex_Revenue 
from '+@tmptable+' where  MonthName = ''Oct'' group by MonthName, Team) b
on a.Team = b.Team' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Nov = b.Apex_Revenue from '+@tmptableYear+' a join
(select MonthName, max(Team)Team, Sum(Amount + Ref_Amount)Apex_Revenue 
from '+@tmptable+' where  MonthName = ''Nov'' group by MonthName, Team) b
on a.Team = b.Team' 
print(@strQry)
exec(@strQry)

set @strQry = ' update a set a.Dec = b.Apex_Revenue from '+@tmptableYear+' a join
(select MonthName, max(Team)Team, Sum(Amount + Ref_Amount)Apex_Revenue 
from '+@tmptable+' where  MonthName = ''Dec'' group by MonthName, Team) b
on a.Team = b.Team' 
print(@strQry)
exec(@strQry)




end
